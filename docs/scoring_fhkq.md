# FHKQ（连续跌停开板 / 反抽博弈）评分机制说明

> 风险声明：连续跌停博弈属于极端情绪交易，波动和不确定性极高。本模型仅用于研究与辅助决策，不构成投资建议。

本文解释 `fhkq.py` 的评分逻辑：它会在指定交易日（`trade_date`）从日线数据中筛出“当日跌停”的股票，统计连续跌停天数并给出 0～100 的博弈评分与等级。

---

## 1. 输入与数据口径

### 1.1 输入数据（单股票或多股票）

`fhkq.py` 评分依赖日线 OHLCV（**日K**）数据，字段口径如下：

- 必需列：`stock_code`, `date`, `open`, `high`, `low`, `close`, `volume`, `amount`
- 可选列：`stock_name`, `is_st`, `limit_down`

其中：
- `date` 统一按 `YYYY-MM-DD` 处理
- `volume/amount` 用于计算放量/放额因子（与 5 日均值对比）
- `limit_down` 若未提供，会按“跌停价推算规则”计算

### 1.2 trade_date

- 支持 `YYYYMMDD` 或 `YYYY-MM-DD`
- 评分只针对 `date == trade_date` 的那一根 K 线（并会用到之前若干日作为历史窗口）

---

## 2. 核心定义

### 2.1 跌停价推算规则（当缺少 `limit_down` 列）

若输入数据没有 `limit_down`，程序会用 **前一日收盘价** 推算当日跌停价：

```
limit_down = round(prev_close * (1 - limit_pct), 2)
```

其中 `limit_pct` 依股票板块/状态推断（仅用于计算跌停价；实际涨跌停制度如有调整以交易所为准）：

- ST（`is_st==1`）：`5%`
- 创业板/科创板（代码前缀 `300`/`301`/`688`）：`20%`
- 北交所（代码前缀 `8`/`4`）：`30%`
- 其它 A 股：`10%`

### 2.2 跌停判定

当日是否跌停（容差 `eps=1e-3`）：

```
abs(close - limit_down) <= eps
```

### 2.3 连续跌停天数（consecutive_limit_down）

- 从 `trade_date` 开始向前回溯
- 统计连续“收盘跌停”的天数
- 遇到第一根 **非跌停** K 线即停止

### 2.4 开板判定（open_board_flag）

“开板”的直觉是：盘中曾经离开跌停（能成交到跌停价之上），但收盘仍然封死跌停。

实现优先使用当日最高价：

```
open_board_flag = 1 if high > limit_down else 0
```

代码中保留了一个兜底（用于极少数脏数据场景）：如果 `low < limit_down` 也视为“出现过开板痕迹”。

---

## 3. 硬性剔除（不参与评分）

只要命中以下任一条件，会被直接剔除：

1) `is_st == 1`（若提供该列）
2) 股票名称包含：`ST` / `*ST` / `退`（忽略大小写）
3) 最近 5 日：**连续跌停** 且 `volume == 0`（一字跌停无流动性）
4) 最近 10 日累计跌幅 > 60%：

```
close_today / close_10days_ago - 1 <= -0.60
```

---

## 4. 评分因子与分值（总分 100）

评分由 5 个部分相加构成，范围 0～100：

### 4.1 连续跌停结构分（0～30）

| 连续跌停天数 | 得分 |
| --- | --- |
| 2 | 10 |
| 3 | 20 |
| 4 | 30 |
| ≥5 | 15 |
| <2 | 0（一般也会被前置条件过滤掉） |

> 直觉：2～4 板“情绪释放+反抽空间”相对可控；≥5 板风险陡增，结构分反而下降。

### 4.2 成交量释放分（0～20）

```
volume_ratio = volume_today / mean(volume_last_5_days)
```

分值规则：

| volume_ratio | 得分 |
| --- | --- |
| < 0.5 | 0 |
| [0.5, 1.0) | 10 |
| [1.0, 2.0] | 20 |
| > 2.0 | 15 |

> 直觉：适度放量（1～2 倍）更像“换手释放”；过度放量可能是恐慌砸盘或出清过猛，得分回落。

### 4.3 成交额释放分（0～10）

```
amount_ratio = amount_today / mean(amount_last_5_days)
```

分值规则：

| amount_ratio | 得分 |
| --- | --- |
| < 0.5 | 0 |
| [0.5, 1.5) | 5 |
| ≥ 1.5 | 10 |

### 4.4 跌停开板分（0 或 20）

- 未开板：`0`
- 发生开板：`20`

> 直觉：开板代表封单松动、盘中有承接（或有资金试图撬板），是博弈信号的核心加分项。

### 4.5 流动性衰竭分（0 或 20）

满足以下条件记为流动性衰竭：

```
liquidity_exhaust =
  consecutive_limit_down >= 3
  and volume_ratio >= 1.0
  and open_board_flag == 1
```

- 不满足：`0`
- 满足：`20`

> 直觉：经历多日跌停后出现开板并伴随放量，可能代表“抛压衰竭 + 接力尝试”，属于更强的博弈形态。

---

## 5. 总分计算与额外惩罚

基础总分：

```
fhkq_score =
  结构分
+ 成交量释放分
+ 成交额释放分
+ 开板分
+ 流动性衰竭分
```

边界处理：
- 分数会被限制到 `[0, 100]`
- 当连续跌停天数 `> 6` 时，会额外扣分（每多 1 天扣 5 分，最多扣 20 分）

---

## 6. 等级划分（fhkq_level）

| fhkq_score | 等级 | 含义 |
| --- | --- | --- |
| ≥ 80 | A | 高概率开板博弈（仍需人工确认） |
| 60～79 | B | 可参与型（偏谨慎） |
| 40～59 | C | 仅观察 |
| < 40 | D | 不参与 |

---

## 7. 输出字段

评分结果输出为 CSV/DataFrame，核心字段：

- `trade_date`, `stock_code`, `stock_name`
- `consecutive_limit_down`, `last_limit_down`
- `volume_ratio`, `amount_ratio`
- `open_board_flag`, `liquidity_exhaust`
- `fhkq_score`, `fhkq_level`

